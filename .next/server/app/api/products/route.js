"use strict";(()=>{var e={};e.id=684,e.ids=[684],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5043:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>P,requestAsyncStorage:()=>O,routeModule:()=>v,serverHooks:()=>R,staticGenerationAsyncStorage:()=>A});var s,a,o={};r.r(o),r.d(o,{GET:()=>x,POST:()=>C});var i=r(9303),c=r(8716),n=r(3131),l=r(7070),u=r(4184),d=r(5637),p=r(2321);class g{set(e,t,r){let s={data:t,timestamp:Date.now(),ttl:r||this.defaultTTL};this.cache.set(e,s)}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}cleanup(){let e=Date.now(),t=0;for(let r of Array.from(this.cache.entries())){let[s,a]=r;e-a.timestamp>a.ttl&&(this.cache.delete(s),t++)}return t}stats(){return{size:this.cache.size,keys:Array.from(this.cache.keys()),memoryUsage:JSON.stringify(Array.from(this.cache.entries())).length}}constructor(){this.cache=new Map,this.defaultTTL=3e5}}let m=new g,h={products:e=>`products:${JSON.stringify(e||{})}`};"undefined"!=typeof setInterval&&setInterval(()=>{let e=m.cleanup();e>0&&console.log(`Cache cleanup: removed ${e} expired items`)},6e5);class f{set(e,t,r=3e5){}get(e){return null}delete(e){}clear(){}constructor(){this.prefix="wellLi:"}}new f;var y=r(2456);let w=(s=async e=>{await (0,p.dM)();let t=(await (0,u.N8)()).collection(u.Ul.PRODUCTS),[r,s,a]=await Promise.all([t.find(e.query).sort({[e.sortBy]:e.sortOrder}).skip(e.skip).limit(e.limit).toArray(),t.countDocuments(e.query),t.distinct("category",{active:!0})]);return{products:r,total:s,categories:a}},a=e=>h.products(e),async(...e)=>{let t=a(...e),r=m.get(t);if(null!==r)return r;try{let r=await s(...e);return m.set(t,r,3e5),r}catch(e){throw e}});async function x(e){try{let{searchParams:t}=new URL(e.url),r=t.get("category"),s=t.get("featured"),a=t.get("search"),o=Math.min(parseInt(t.get("limit")||"20"),100),i=Math.max(parseInt(t.get("skip")||"0"),0),c=t.get("sortBy")||"sortOrder",n="desc"===t.get("sortOrder")?-1:1;try{await (0,p.dM)(),(await (0,u.N8)()).collection(u.Ul.PRODUCTS);let e={active:!0};if(r&&"all"!==r&&"string"==typeof r&&(e.category=r.trim()),"true"===s&&(e.featured=!0),a&&"string"==typeof a&&a.trim().length>0){let t=a.trim();e.$or=[{name:{$regex:t,$options:"i"}},{description:{$regex:t,$options:"i"}},{category:{$regex:t,$options:"i"}}]}let t=["sortOrder","name","category","createdAt","updatedAt"].includes(c)?c:"sortOrder",{products:d,total:g,categories:m}=await w({query:e,sortBy:t,sortOrder:n,skip:i,limit:o}),h=d.map(e=>({...e,id:e._id?.toString()||e.slug,image:Array.isArray(e.images)&&e.images.length>0?e.images[0]:"/images/products/default.svg"}));return l.NextResponse.json({products:h,pagination:{total:g,limit:o,skip:i,hasMore:i+o<g},categories:m,success:!0},{headers:{...y.S5,"Cache-Control":"public, max-age=300",ETag:`"products-${Date.now()}"`}})}catch(u){console.warn("⚠️  Database connection failed, using fallback data:",u);let e=function(){let e=p.H6.map((e,t)=>({...e,_id:`sample_${t}`,id:`sample_${t}`,image:Array.isArray(e.images)&&e.images.length>0?e.images[0]:"/images/products/default.svg"}));return{products:e,pagination:{total:e.length,limit:20,skip:0,hasMore:!1},categories:["Small Cases","Medium Cases","Large Cases","Tool Cases","Custom Cases"],success:!0}}();if(r&&"all"!==r&&(e.products=e.products.filter(e=>e.category===r)),"true"===s&&(e.products=e.products.filter(e=>e.featured)),a){let t=a.toLowerCase();e.products=e.products.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.category.toLowerCase().includes(t))}"name"===c?e.products.sort((e,t)=>e.name.localeCompare(t.name)):"category"===c&&e.products.sort((e,t)=>e.category.localeCompare(t.category));let t=i+o,n=e.products.slice(i,t);return l.NextResponse.json({products:n,pagination:{total:e.products.length,limit:o,skip:i,hasMore:t<e.products.length},categories:e.categories,success:!0,note:"使用模拟数据（数据库连接不可用）"},{headers:{...y.S5,"Cache-Control":"no-cache","X-Data-Source":"fallback"}})}}catch(e){return console.error("Error fetching products:",e),l.NextResponse.json({error:"Failed to fetch products",success:!1},{status:500})}}async function C(e){try{let t=await e.json(),r=(0,d.q$)(t);if(!r.isValid)return l.NextResponse.json({error:"Validation failed",details:r.errors},{status:400});let s={...t,name:(0,d.vJ)(t.name||""),description:(0,d.vJ)(t.description||""),category:(0,d.vJ)(t.category||"")},a=(await (0,u.N8)()).collection(u.Ul.PRODUCTS),o=s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");if(await a.findOne({slug:o}))return l.NextResponse.json({error:"Product with this name already exists"},{status:409});let i={...s,slug:o,active:s.active??!0,featured:s.featured??!1,sortOrder:s.sortOrder??0,createdAt:new Date,updatedAt:new Date},c=await a.insertOne(i);return l.NextResponse.json({message:"Product created successfully",productId:c.insertedId,success:!0})}catch(e){return console.error("Error creating product:",e),l.NextResponse.json({error:"Failed to create product",success:!1},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:c.x.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:"app/api/products/route"},resolvedPagePath:"E:\\nanuk\\src\\app\\api\\products\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:O,staticGenerationAsyncStorage:A,serverHooks:R}=v,$="/api/products/route";function P(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:A})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,253,321],()=>r(5043));module.exports=s})();